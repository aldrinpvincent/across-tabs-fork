/*! For license information please see across-tabs.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AcrossTabs=t():e.AcrossTabs=t()}(self,(()=>(()=>{"use strict";var e={d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{default:()=>O});const n="__TAB__LOADED_EVENT__",i="__TAB__CUSTOM_EVENT__",s="__TAB__HANDSHAKE_EVENT__",o="__TAB__ON_BEFORE_UNLOAD__",a="__PARENT_DISCONNECTED__",r="__HANDSHAKE_WITH_PARENT__",d="__PARENT_COMMUNICATED__";let l={},h={INDEX:"index",OBJECT:"object",BOTH:"both"};l.searchByKeyName=(e,t,n,i)=>{if(!e||!t)return!1;i=i||h[1];let s,o,a,r=-1;for(s=0;s<e.length;s++){if(o=e[s],!isNaN(n)&&parseInt(o[t],10)===parseInt(n,10)){r=s;break}if(isNaN(n)&&o[t]===n){r=s;break}}switch(-1===r&&(e[r]={}),i){case h.INDEX:a=r;break;case h.BOTH:a={obj:e[r],index:r};break;default:a=e[r]}return a};const c=l,g="open",f="close",w="Invalid JSON Object!",u="Some wrong message is being sent by Parent.",m="Configuration options required. Please read docs.",p="Url is needed for creating and opening a new window/tab. Please read docs.";let b={tabs:[],config:{},_remove:e=>{let t;t=c.searchByKeyName(b.tabs,"id",e.id,"index"),b.tabs.splice(t,1)},_preProcessMessage:e=>{try{e=b.config.stringify(e)}catch(e){throw new Error(w)}return e&&-1===e.indexOf(d)&&(e=d+e),e},addNew:e=>{b.tabs.push(e)},getOpened:()=>b.tabs.filter((e=>e.status===g)),getClosed:()=>b.tabs.filter((e=>e.status===f)),getAll:()=>b.tabs,closeTab:e=>{let t=c.searchByKeyName(b.tabs,"id",e);return t&&t.ref&&(t.ref.close(),t.status=f),b},closeAll:()=>{let e;for(e=0;e<b.tabs.length;e++)b.tabs[e]&&b.tabs[e].ref&&(b.tabs[e].ref.close(),b.tabs[e].status=f);return b},broadCastAll:(e,t)=>{let n,i=b.getOpened();for(e=b._preProcessMessage(e),n=0;n<i.length;n++)b.sendMessage(i[n],e,t);return b},broadCastTo:(e,t,n)=>{let i,s=b.getAll();return t=b._preProcessMessage(t),i=c.searchByKeyName(s,"id",e),b.sendMessage(i,t,n),b},sendMessage:(e,t,n)=>{let i=b.config.origin||"*";if(n&&e.ref[0])for(let n=0;n<e.ref.length;n++)e.ref[n].postMessage(t,i);else e.ref&&e.ref.top&&e.ref.top.postMessage(t,i)}};const _=b;let y;y=function(){function e(){}return e.generate=function(){let t=e._getRandomInt,n=e._hexAligner;return n(t(32),8)+"-"+n(t(16),4)+"-"+n(16384|t(12),4)+"-"+n(32768|t(14),4)+"-"+n(t(48),12)},e._getRandomInt=function(e){return e<0?NaN:e<=30?0|Math.random()*(1<<e):e<=53?(0|Math.random()*(1<<30))+(0|Math.random()*(1<<e-30))*(1<<30):NaN},e._getIntAligner=function(e){return function(t,n){let i=t.toString(e),s=n-i.length,o="0";for(;s>0;s>>>=1,o+=o)1&s&&(i=o+i);return i}},e._hexAligner=e._getIntAligner(16),e.prototype.toString=function(){return this.hexString},e}();const E=y,T=e=>{if(!e)return!1;let t,n=document.querySelectorAll("["+e+"]");for(t=0;t<n.length;t++)n[t].setAttribute("disabled","disabled")},S=e=>{if(!e)return!1;let t,n=document.querySelectorAll("["+e+"]");for(t=0;t<n.length;t++)n[t].removeAttribute("disabled")};(()=>{function e(e,t={}){let n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!1,!1,t.detail),n}"function"!=typeof window.CustomEvent&&(e.prototype=window.Event.prototype,window.CustomEvent=e)})();let C={_onLoad:e=>{let t,i,s=e.split(n)[1];if(s)try{s=_.config.parse(s),s.id&&(t=_.getAll(),t.length&&(window.newlyTabOpened=t[t.length-1],window.newlyTabOpened.id=s.id,window.newlyTabOpened.name=s.name||s.windowName))}catch(e){throw new Error(w)}if(window.newlyTabOpened)try{i=r,i+=_.config.stringify({id:window.newlyTabOpened.id,name:window.newlyTabOpened.name||window.newlyTabOpened.windowName,parentName:window.name}),_.sendMessage(window.newlyTabOpened,i,s.isSiteInsideFrame)}catch(e){throw new Error(w)}},_onCustomMessage:(e,t)=>{let n,i,s=e.split(t)[1];try{s=_.config.parse(s)}catch(e){throw new Error(w)}i={tabInfo:s,type:t},n=new CustomEvent("onCustomChildMessage",{detail:i}),window.dispatchEvent(n)},_onBeforeUnload:e=>{let t,n=e.split(o)[1];try{n=_.config.parse(n)}catch(e){throw new Error(w)}_.tabs.length&&(t=_.getAll(),window.newlyTabOpened=c.searchByKeyName(t,"id",n.id)||window.newlyTabOpened);let i=new CustomEvent("onChildUnload",{detail:n});window.dispatchEvent(i)},onNewTab:e=>{let t=e.data;return!(!t||"string"!=typeof t||!_.tabs.length)&&(!_.config.origin||_.config.origin===e.origin)&&void(t.indexOf(n)>-1?C._onLoad(t):t.indexOf(i)>-1?C._onCustomMessage(t,i):t.indexOf(s)>-1?C._onCustomMessage(t,s):t.indexOf(o)>-1&&C._onBeforeUnload(t))}};const N=C;let I,v;const O={Parent:class{constructor(e){void 0===(e=e||{}).heartBeatInterval&&(e.heartBeatInterval=500),void 0===e.shouldInitImmediately&&(e.shouldInitImmediately=!0),"function"!=typeof e.parse&&(e.parse=JSON.parse),"function"!=typeof e.stringify&&(e.stringify=JSON.stringify),_.tabs=[],this.Tab=class{constructor(){window.name=window.name||"PARENT_TAB"}create(e){return e=e||{},Object.assign(this,e),this.id=E.generate()||_.tabs.length+1,this.status="open",this.ref=window.open(this.url,e.windowName||"_blank",e.windowFeatures),T("data-tab-opener"),window.newlyTabOpened={id:this.id,name:this.name||this.windowName,ref:this.ref},_.addNew(this),this}},Object.assign(this,e),_.config=e,this.shouldInitImmediately&&this.init()}addInterval(){let e,t=_.getAll(),n=_.getOpened();if(!n||!n.length)return window.clearInterval(I),I=null,!1;for(e=0;e<t.length;e++)this.removeClosedTabs&&this.watchStatus(t[e]),t[e]&&t[e].ref&&(t[e].status=t[e].ref.closed?f:g);this.onPollingCallback&&this.onPollingCallback()}startPollingTabs(){I=window.setInterval((()=>this.addInterval()),this.heartBeatInterval)}watchStatus(e){if(!e||!e.ref)return!1;let t=e.ref.closed?f:g,n=e.status;if(!t||t===n)return!1;n===g&&t===f&&_._remove(e)}onChildUnload(e){this.onChildDisconnect&&this.onChildDisconnect(e.detail)}customEventUnListener(e){this.enableElements(),e.detail&&e.detail.type===s&&this.onHandshakeCallback?this.onHandshakeCallback(e.detail.tabInfo):e.detail&&e.detail.type===i&&this.onChildCommunication&&this.onChildCommunication(e.detail.tabInfo)}addEventListeners(){window.removeEventListener("message",N.onNewTab),window.addEventListener("message",N.onNewTab),window.removeEventListener("onCustomChildMessage",this.customEventUnListener),window.addEventListener("onCustomChildMessage",(e=>this.customEventUnListener(e))),window.removeEventListener("onChildUnload",this.onChildUnload),window.addEventListener("onChildUnload",(e=>this.onChildUnload(e))),window.onbeforeunload=()=>{_.broadCastAll(a)}}enableElements(){S("data-tab-opener")}getAllTabs(){return _.getAll()}getOpenedTabs(){return _.getOpened()}getClosedTabs(){return _.getClosed()}closeAllTabs(){return _.closeAll()}closeTab(e){return _.closeTab(e)}broadCastAll(e){return _.broadCastAll(e)}broadCastTo(e,t){return _.broadCastTo(e,t)}openNewTab(e){if(!e)throw new Error(m);if(!e.url)throw new Error(p);return v=new this.Tab,v.create(e),I||this.startPollingTabs(),v}init(){this.addEventListeners()}},Child:class{constructor(e){this.sessionStorageKey="__vwo_new_tab_info__",e||(e={}),void 0===e.handshakeExpiryLimit&&(e.handshakeExpiryLimit=5e3),void 0===e.shouldInitImmediately&&(e.shouldInitImmediately=!0),"function"!=typeof e.parse&&(e.parse=JSON.parse),"function"!=typeof e.stringify&&(e.stringify=JSON.stringify),this.tabName=window.name,this.tabId=null,this.tabParentName=null,Object.assign(this,e),this.config=e,this.shouldInitImmediately&&this.init()}_isSessionStorage(){return!(!("sessionStorage"in window)||!window.sessionStorage)}_getData(){return!!this.isSessionStorageSupported&&window.sessionStorage.getItem(this.sessionStorageKey)}_setData(e){return!!this.isSessionStorageSupported&&(window.sessionStorage.setItem(this.sessionStorageKey,e),e)}_restoreData(){if(!this.isSessionStorageSupported)return!1;if(this.isSessionStorageSupported){let e=this._getData();this._parseData(e)}}_parseData(e){let t;try{t=this.config.parse(e),this.tabId=t&&t.id,this.tabName=t&&t.name,this.tabParentName=t&&t.parentName}catch(e){throw new Error(u)}}onCommunication(e){let t,n=e.data;if(n&&"string"==typeof n&&(!this.config.origin||this.config.origin===e.origin)){if(window.clearTimeout(this.timeout),n.indexOf(a)>-1&&(this.config.onParentDisconnect&&this.config.onParentDisconnect(),window.removeEventListener("message",(e=>this.onCommunication(e)))),n.indexOf(r)>-1){let e;t=n.split(r)[1],this._setData(t),this._parseData(t),e={id:this.tabId,isSiteInsideFrame:this.config.isSiteInsideFrame},this.sendMessageToParent(e,s),this.config.onInitialize&&this.config.onInitialize()}if(n.indexOf(d)>-1){t=n.split(d)[1];try{t=this.config.parse(t)}catch(e){throw new Error(w)}this.config.onParentCommunication&&this.config.onParentCommunication(t)}}}addListeners(){window.onbeforeunload=e=>{let t={id:this.tabId,isSiteInsideFrame:this.config.isSiteInsideFrame};this.sendMessageToParent(t,o)},window.removeEventListener("message",(e=>this.onCommunication(e))),window.addEventListener("message",(e=>this.onCommunication(e)))}setHandshakeExpiry(){return window.setTimeout((()=>{this.config.onHandShakeExpiry&&this.config.onHandShakeExpiry()}),this.handshakeExpiryLimit)}sendMessageToParent(e,t){let n;e=(t||i)+this.config.stringify(e),window.top.opener&&(n=this.config.origin||"*",window.top.opener.postMessage(e,n))}getTabInfo(){return{id:this.tabId,name:this.tabName,parentName:this.tabParentName,isSiteInsideFrame:this.config.isSiteInsideFrame}}init(){this.isSessionStorageSupported=this._isSessionStorage(),this.addListeners(),this._restoreData(),this.sendMessageToParent(this.getTabInfo(),n),this.timeout=this.setHandshakeExpiry(),this.config.onReady&&this.config.onReady()}}};return t})()));